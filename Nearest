spawn(function()
    while wait() do
        if _G.AutoFarmNearest then
            for i, v in pairs(game:GetService("Workspace").Enemies:GetChildren()) do
                if v.Name and v:FindFirstChild("Humanoid") and v:FindFirstChild("HumanoidRootPart") then
                    if v.Humanoid.Health > 0 then

                        -- ✅ FILTRO: só ataca inimigo que está na mesma ilha do player
                        if not IsEnemyOnSameIsland(v.HumanoidRootPart) then
                            continue -- pula para o próximo inimigo
                        end

                        repeat
                            wait()
                            EquipWeapon(_G.SelectWeapon)

                            if not game.Players.LocalPlayer.Character:FindFirstChild("HasBuso") then
                                local args = {
                                    [1] = "Buso"
                                }
                                game:GetService("ReplicatedStorage").Remotes.CommF_:InvokeServer(unpack(args))
                            end

                            topos(v.HumanoidRootPart.CFrame * Pos)
                            v.HumanoidRootPart.CanCollide = false
                            Fastattack = true
                            v.HumanoidRootPart.Size = Vector3.new(10, 10, 10)
                            game:GetService("VirtualUser"):CaptureController()
                            game:GetService("VirtualUser"):Button1Down(Vector2.new(50, 62), game.Workspace.CurrentCamera.CFrame)
                            AutoFarmNearestMagnet = true
                            PosMon = v.HumanoidRootPart.CFrame

                            -- ✅ VERIFICAÇÃO CONTÍNUA: se o inimigo saiu da ilha, para o loop
                            if not IsEnemyOnSameIsland(v.HumanoidRootPart) then
                                break
                            end

                        until not _G.AutoFarmNearest or not v.Parent or v.Humanoid.Health <= 0

                        -- ✅ Reset das variáveis globais ao sair do loop
                        AutoFarmNearestMagnet = false
                        Fastattack = false
                    end
                end
            end
        end
    end
end)
